# 13장 PIC 컨트롤러와 인터럽트 핸들러를 이용해 인터럽트를 처리하자

---

## 13.1 PIC 컨트롤러 소개

### 13.1.1 PIC 컨트롤러란
PIC 컨트롤러는 Programmable Interrupt Controller의 약자로 인터럽트 처리에 관련된 기능을 프로그래밍 할 수 있는 컨트롤러다.

PIC 컨트롤러 2개를 마스터-슬레이브 방식으로 연결하여 최대 15개의 인터럽트를 처리할 수 있다. 마스터의 2번 핀을 슬래이브와 연결하는데 사용하기 때문에 15개만 처리 가능하다.

마스터와 슬레이브 순으로 부여한 이터럽트 핀 번호를 IRQ (Interrupt Request) 번호라고 부르며, 각각의 핀은 PC 디바이스의 인터럽트 핀과 연결되 어 있다.

### 13.1.2 PIC 컨트롤러의 구조와 동작 방식

![](asset/cpu_pic8259.PNG)

PIC 컨트롤러는 내부에 8비트 크기의 IRR, ISR, IMR 레지스터가 있다. 레지스터의 역할은 다음과 같다.

* IRR(Interrupt Request Register) 는 외부 디바이스와 연결된 인터럽트 핀 중에서 인터럽트가 발생한 핀의 정보를 관리한다. 외부 디바이스가 인터럽트를 발생시키면 PIC 컨트롤러는 IRR에 해당 비트를 1로 설정하여 인터럽트 발생 여부를 저장한다.
* ISR(In-Service Register) 는 현재 인터럽트 핸들러가 실행 중인 인터럽트의 정보를 나타낸다. PIC 컨트롤러는 특별한 옵션을 사용하지 않는 한 IRQ 0에 가까울수록 우선순위를 높게 설정하므로 ISR에 설정된 비트는 IRR에 설정된 비트 중에서 0에 가까운 비트와 같다.
* IMR(Interrupt Mask Register)는 비트가 1로 설정된 인터럽트 핀에서 발생한 인터럽트 요청을 무시하는 역할을 한다.

PIC 컨트롤러의 INT 핀과 프로세서의 INTR이 연결되어 있고, 인터럽트가 발생했을 때 INT 핀에 신호를 발생시켜 프로세서가 인터럽트를 처리하게 한다.
PIC의 /INTA 핀은 인터럽트가 프로세서에 잘 전달되었음을 프로세서가 알려주는 핀이다.

처리하는 과정은 아래와 같다.

1. PIC에 인터럽트 요청이 수신되고, PIC은 IRR의 해당 비트를 1로 설정
2. PIC은 INT 핀으로 신호를 보내 프로세서에 인터럽트가 발생했음을 알림
3. 프로세서는 /INTA 핀으로 인터럽트 요청이 정상적으로 수신되었음을 PIC에 알림
4. PIC은 IRR에서 가장 우선순위가 높은 것을 찾아 삭제한 뒤 ISR의 해당피트에 1로 설정 후 인터럽트 벡터의 번호를 프로세서에 전송
5. 프로세서는 인터럽트 처리 완료 후 EOI 커맨드를 PIC에 전송하고, PIC 컨트롤러는 ISR에 설정된 비트를 삭제
6. 인터럽트 완료 후 IRR 레지스터를 확인하여 처리되지 않은 인터럽트 요청이 있다면 2~5 과정을 반복

## 13.2 PIC 컨트롤러 제어

### 13.2.1 PIC 컨트롤러 초기화

PIC 컨트롤러는 I/O 포트 방식으로 연결되어 있다. 인텔 PC는 PIC 컨트롤러에 각각 두 개의 I/O 포트를 할당하며, 마스터 PIC은 0x20과 0x21을 사용하고 슬레이브 PIC은  0xA0, 0xA1을 사용한다.

PIC은 초기화와 관련된 ICW 커맨드와 제어에 관련된 OCW 커맨드가 있다. ICW 커맨드는 ICW1~4 까지 네가지가 있다. 

초기화 하는 작업은 ICW1 커맨드를 I/O 포트 0x20 또는 0xA0에 쓰는 것으로 시작한다. ICW1을 보내면 ICW2,3,4를 순서대로 해석하고 수신된 커맨드를 바탕으로 자신을 초기화한다.

### 13.2.3 인터럽트 입력 선택

PIC는 IRQ를 특정 백터에 매핑하는 기능 외에 특정 인터럽트를 무시하는 기능이 있다. IMR에 무시할 인터럽트를 1로 설정해야 하며, OCW1 커맨드가 이런 역할을 담당한다.

### 13.2.3 인터럽트 종료 처리

프로세서는 인터럽트 처리를 완료한 후 다시 PIC 컨트롤러에 이를 알려주어야 한다. 알려주지 않는다면 PIC은 핸들러가 수행중인 것으로 간주하고, 현재 발생한 인터럽트보다 우선순위가 낮은 인터럽트는 발생시키지 않는다.

PIC에 EOI를 전송하려면 OCW2 커맨드를 사용해야한다. EOI를 전송할 때 주의할 점은 슬래이브 PIC에 EOI를 전송하면 마스터 PIC에도 EOI를 전송해야 한다. 왜냐하면 슬레이브 PIC에 인터럽트가 발생하면 마스터 PIC을 통해 프로세서로 전달되기 때문이다.

## 13.3 인터럽트, 예외 핸들러, 콘텍스트

### 13.3.1 임시 핸들러의 문제점

인터럽트나 예외가 발생하면 프로세서는 수행 중인 코드로 복귀하는 데 필요한 기본 정보를 핸들러의 스택에 삽입한다. 핸들러 수행 후 코드로 복귀하려면 저장된 데이터를 프로세서에 다시 복원해야 하는 데, 이러한 작업을 수행하려면 IRET 명령어를 명시적으로 사용해야한다.

프로세서에는 인터럽트 또는 예외 발생 시 자동으로 저장하는 레지스터 외에도 많은 레지스터가 있다. 이러한 레지스터들은 프로세서가 별도로 관리하지 않으므로 핸들러에서 이를 처리해야 한다. 

### 13.3.2 콘테그슽 저장과 복원

인터럽트 똔느 예외가 발생했을 때, 핸들러를 수생한 후 코드로 복귀하려면 프로세서의 상태를 저장하고 복원해야 한다. 이런 프로세서의 상태와 관련된 레지스터의 집합을 다른 말로 콘텍스트라고 한다.

콘텍스트를 유지하는 방법은 콘텍스트를 위한 메모리 공간을 할당한 뒤, 정해진 순서대로 레지스터를 저장하고 복원한다. 프로세서가 하는 역할은 단순히 IST 스택에 콘텍스트의 일부를 저장하고 복원하는 것이다. 

### 13.3.3 인터럽트와 예외 핸들러 업그레이드

핸들러는 크게 콘텍스트를 저장하고 복원하는 역할을 담당하는 어셈블리어 코드(ISR, Interrupt Service Routine)과 실제 처리를 담당하는 C 코드 핸들러 함수로 구성된다.

### 13.3.4 IDT 테이블 수정

### 13.3.5 인터럽트 활성화와 비활성화

인터럽트를 활성화하고 싶다면 STI 명령어를, 비활성화하고 싶다면 CLI 명령어를 사용하면 된다.

## 13.4 PIC 컨트롤러 제어 코드와 핸들러 코드의 통합과 빌드
