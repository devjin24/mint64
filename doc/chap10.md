# 10장 64비트 모드로 전환하자

IA-32e 모드로 전환하는 7단계
1. 세그먼트 디스크립터 추가(IA-32e 모드 코드와 데이터용 세그먼트 디스크립터 추가)
2. CR4 컨트롤러 레즈스터 설정(CR4 컨트롤 리지스터의 PAE 비트=1)
3. CR3 컨트롤 레지스터 설정(CR3 컨트롤 레지스터에 PML4 테이블 어드레스 설정)
4. IA32_EFER 레지스터 설정(IA32_EFER 레즈스터(MSR 레지스터)의 LME 비트=1)
5. CR0 컨트롤 레지스터 설정(CR0 컨트롤 레지스터의 PG 비트=1)
6. jmp 명령으로 CS 세그먼트 셀렉터 변경 및 IA-32e 모드로 전환(jmp 0x18:IA-32e 모드 커널의 시작 어드레스)
7. 각종 세그먼트 셀렉터와 스택 초기화(DS, ES, FS, GS, SS 세그먼트 셀렉터와 RSP, RBP 레지스터 초기화)

디스크립터와 셀렉터를 갱신하는 부분과 페이징을 활성화하는 부분, IA-32e 모드로 전환하는 부분의 세 가지로 나눌 수 있다.

## 10.1 프로세서의 제조사와 IA-32e 지원 여부 검사
CPUID 명령어로 프로세서 제조사가 지원하는 기능을 확인할 수 있다.

### 10.1.1 CPUID를 사용하여 프로세서 정보 확인 방법
CPUID는 EAX 레지스터에 설정된 값에 따라 해당 정보를 조회하며, EAX,EBX, ECX, EDX를 통해 결과를 넘겨준다.  
* CPUID 명령어를 실행했을 때, 반환되는 정보는 프로세서 제조사에 따라 다르다.

### 10.1.2 프로세서 제조사와 IA-32e 모드 지원 여보 확인
* 어셈블리어 코드에서 해당 함수가 외부에서 사용된다는 것을 알릴때는 global 지시어를 사용한다.

## 10.2 IA-32e 모드용 세그먼트 디스크립터 추가
### 10.2.1 보호 모드 커널 엔트리 포인트에 디스크립터 추가
보호 모드 디스크립터와 IA-32e 모드 디스크립터의 차이는 디스크립터의 기준 주소와 세그먼트 크기 값에 상관없이 64GB 전체 영역으로 설정된다는 것과 
세그먼트 디스크립터의 L 비트가 IA-32e 서브 모드 중 호환 모드 또는 64비트 모드를 선택하는 데 사용된다는 것이다.

## 10.3 IA-32e 모드 전환과 1차 정리
### 10.3.1 물리 메모리 확장 기능 활성화와 페이지 테이블 설정
### 10.3.2 64비트 모드 활성화와 페이징 활성화
IA32_EFER 레지스터의 LME 비트를 1로 설정하여 IA-32e모드를 활성화 한다.  
MSR(Model-Specific Register) 레지스터
* 디버깅 및 성능 측정
* 하드웨어 에러 검사
* 메모리 범위와 메모리 타입 설정
* 온도와 전력 관리
* 특수 명령어 지원
* 프로세서 특성과 모드 지원
RDMSR ,WRMSR 명령어로 읽고 쓸 수 있음

### 10.3.3 IA-32e 모드로 전환과 세그먼트 셀렉터 초기화
CR0 레지스터를 변경하여 캐시와 페이징을 활성화하고서 세그먼트 셀렉터를 IA-32e 커널용으로 교체하는 것이다.


### 10.3.4 소스코드 1차 정리와 실행

## 10.4 IA-32e 모드용 커널 준비
어셈블리어 함수에서 C 함수를 호출할때 extern 지시어로 해당 C 함수가 외부에 있다는 것을 알릴 수 있다.
